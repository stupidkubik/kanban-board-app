rules_version = "2";

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function userProfileKeysValid() {
      return request.resource.data.keys().hasOnly([
        "preferredLocale",
        "email",
        "createdAt",
        "updatedAt"
      ]);
    }

    function preferredLocaleValid() {
      return !request.resource.data.keys().hasAny(["preferredLocale"])
        || request.resource.data.preferredLocale in ["ru", "en"];
    }

    function emailValid() {
      return !request.resource.data.keys().hasAny(["email"])
        || request.resource.data.email is string
        || request.resource.data.email == null;
    }

    function isMember() {
      return isSignedIn()
        && resource.data.members is map
        && resource.data.members[request.auth.uid] == true;
    }

    function memberRole() {
      return resource.data.roles is map ? resource.data.roles[request.auth.uid] : null;
    }

    function hasLanguage() {
      return request.resource.data.keys().hasAny(["language"]);
    }

    function isLanguageValid() {
      return !hasLanguage() || request.resource.data.language in ["ru", "en"];
    }

    function boardKeysValid() {
      return request.resource.data.keys().hasOnly([
        "title",
        "ownerId",
        "members",
        "roles",
        "language",
        "createdAt",
        "updatedAt",
        "createdBy"
      ]);
    }

    function boardTitleValid() {
      return request.resource.data.title is string
        && request.resource.data.title.size() > 0;
    }

    function boardCreatedByValid() {
      return !request.resource.data.keys().hasAny(["createdBy"])
        || request.resource.data.createdBy == request.resource.data.ownerId;
    }

    function isEditor() {
      return isMember()
        && (memberRole() in ["owner", "editor"]);
    }

    function isOwner() {
      return isSignedIn()
        && resource.data.ownerId == request.auth.uid
        && isMember()
        && memberRole() == "owner";
    }

    function ownerUnchanged() {
      return request.resource.data.ownerId == resource.data.ownerId;
    }

    function membersUnchanged() {
      return request.resource.data.members == resource.data.members;
    }

    function rolesUnchanged() {
      return request.resource.data.roles == resource.data.roles;
    }

    function membersValid() {
      return request.resource.data.members is map
        && request.resource.data.members.values().hasOnly([true]);
    }

    function rolesValid() {
      return request.resource.data.roles is map
        && request.resource.data.roles.values().hasOnly(["owner", "editor", "viewer"]);
    }

    function membersRolesInSync() {
      return request.resource.data.members.keys().hasOnly(request.resource.data.roles.keys())
        && request.resource.data.roles.keys().hasOnly(request.resource.data.members.keys());
    }

    function onlyMembersAndRolesChanged() {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(["members", "roles"]);
    }

    function inviteDoc(boardId) {
      return get(/databases/$(database)/documents/boardInvites/$(boardId + "__" + request.auth.token.email));
    }

    function hasInvite(boardId) {
      return request.auth.token.email != null &&
        exists(/databases/$(database)/documents/boardInvites/$(boardId + "__" + request.auth.token.email));
    }

    function inviteRole(boardId) {
      return inviteDoc(boardId).data.role;
    }

    function canAcceptInvite(boardId) {
      return isSignedIn()
        && request.auth.token.email != null
        && hasInvite(boardId)
        && resource.data.members is map
        && request.resource.data.members is map
        && resource.data.roles is map
        && request.resource.data.roles is map
        && ownerUnchanged()
        && onlyMembersAndRolesChanged()
        && request.resource.data.members.diff(resource.data.members).affectedKeys().hasOnly([request.auth.uid])
        && request.resource.data.roles.diff(resource.data.roles).affectedKeys().hasOnly([request.auth.uid])
        && request.resource.data.members[request.auth.uid] == true
        && request.resource.data.roles[request.auth.uid] == inviteRole(boardId);
    }

    match /boards/{boardId} {
      allow read: if isMember();
      allow create: if isSignedIn()
        && boardKeysValid()
        && boardTitleValid()
        && boardCreatedByValid()
        && request.resource.data.ownerId == request.auth.uid
        && membersValid()
        && rolesValid()
        && membersRolesInSync()
        && request.resource.data.members[request.auth.uid] == true
        && request.resource.data.roles[request.auth.uid] == "owner"
        && isLanguageValid();
      allow update: if boardKeysValid()
        && boardTitleValid()
        && boardCreatedByValid()
        && membersValid()
        && rolesValid()
        && membersRolesInSync()
        && isLanguageValid()
        && ((isOwner()
          && ownerUnchanged()
          && request.resource.data.members[request.auth.uid] == true
          && request.resource.data.roles[request.auth.uid] == "owner")
        || (isEditor() && ownerUnchanged() && membersUnchanged() && rolesUnchanged())
        || canAcceptInvite(boardId));
      allow delete: if isOwner();
    }

    match /users/{userId} {
      allow read: if isSelf(userId);
      allow create, update: if isSelf(userId)
        && userProfileKeysValid()
        && preferredLocaleValid()
        && emailValid();
      allow delete: if false;
    }

    function boardDoc(boardId) {
      return get(/databases/$(database)/documents/boards/$(boardId));
    }

    function boardData(boardId) {
      return boardDoc(boardId).data;
    }

    function boardExists(boardId) {
      return exists(/databases/$(database)/documents/boards/$(boardId));
    }

    function isBoardOwner(boardId) {
      return isSignedIn()
        && boardExists(boardId)
        && boardData(boardId).ownerId == request.auth.uid
        && boardData(boardId).members is map
        && boardData(boardId).members[request.auth.uid] == true
        && boardRole(boardId) == "owner";
    }

    function boardRole(boardId) {
      return boardData(boardId).roles is map ? boardData(boardId).roles[request.auth.uid] : null;
    }

    function isBoardMember(boardId) {
      return isSignedIn()
        && boardExists(boardId)
        && boardData(boardId).members is map
        && boardData(boardId).members[request.auth.uid] == true;
    }

    function isBoardEditor(boardId) {
      return isBoardMember(boardId)
        && (boardRole(boardId) in ["owner", "editor"]);
    }

    function hasBoardRole(boardId) {
      return boardRole(boardId) in ["owner", "editor", "viewer"];
    }

    function columnKeysValid() {
      return request.resource.data.keys().hasOnly([
        "title",
        "order",
        "createdAt",
        "updatedAt"
      ]);
    }

    function columnHasRequired() {
      return request.resource.data.keys().hasAll([
        "title",
        "order",
        "createdAt",
        "updatedAt"
      ]);
    }

    function columnTitleValid() {
      return request.resource.data.title is string
        && request.resource.data.title.size() > 0;
    }

    function columnOrderValid() {
      return request.resource.data.order is number;
    }

    function columnTimestampsValid() {
      return request.resource.data.createdAt is timestamp
        && request.resource.data.updatedAt is timestamp;
    }

    function columnCreatedAtUnchanged() {
      return request.resource.data.createdAt == resource.data.createdAt;
    }

    function cardKeysValid() {
      return request.resource.data.keys().hasOnly([
        "columnId",
        "title",
        "description",
        "order",
        "createdById",
        "assigneeIds",
        "labels",
        "dueAt",
        "createdAt",
        "updatedAt",
        "archived"
      ]);
    }

    function cardHasRequired() {
      return request.resource.data.keys().hasAll([
        "columnId",
        "title",
        "order",
        "createdById",
        "createdAt",
        "updatedAt"
      ]);
    }

    function cardColumnValid() {
      return request.resource.data.columnId is string
        && request.resource.data.columnId.size() > 0;
    }

    function cardTitleValid() {
      return request.resource.data.title is string
        && request.resource.data.title.size() > 0;
    }

    function cardOrderValid() {
      return request.resource.data.order is number;
    }

    function cardCreatedByValid() {
      return request.resource.data.createdById is string
        && request.resource.data.createdById.size() > 0;
    }

    function cardDescriptionValid() {
      return !request.resource.data.keys().hasAny(["description"])
        || request.resource.data.description is string
        || request.resource.data.description == null;
    }

    function cardAssigneesValid() {
      return !request.resource.data.keys().hasAny(["assigneeIds"])
        || request.resource.data.assigneeIds is list;
    }

    function cardLabelsValid() {
      return !request.resource.data.keys().hasAny(["labels"])
        || request.resource.data.labels is list;
    }

    function cardDueAtValid() {
      return !request.resource.data.keys().hasAny(["dueAt"])
        || request.resource.data.dueAt is timestamp
        || request.resource.data.dueAt == null;
    }

    function cardArchivedValid() {
      return !request.resource.data.keys().hasAny(["archived"])
        || request.resource.data.archived is bool;
    }

    function cardTimestampsValid() {
      return request.resource.data.createdAt is timestamp
        && request.resource.data.updatedAt is timestamp;
    }

    function cardCreatedByUnchanged() {
      return request.resource.data.createdById == resource.data.createdById;
    }

    function cardCreatedAtUnchanged() {
      return request.resource.data.createdAt == resource.data.createdAt;
    }

    function memberProfileKeysValid() {
      return request.resource.data.keys().hasOnly([
        "displayName",
        "photoURL",
        "email",
        "joinedAt"
      ]);
    }

    function memberProfileDataValid() {
      return (!request.resource.data.keys().hasAny(["displayName"])
        || request.resource.data.displayName is string
        || request.resource.data.displayName == null)
      && (!request.resource.data.keys().hasAny(["photoURL"])
        || request.resource.data.photoURL is string
        || request.resource.data.photoURL == null)
      && (!request.resource.data.keys().hasAny(["email"])
        || request.resource.data.email is string
        || request.resource.data.email == null)
      && (!request.resource.data.keys().hasAny(["joinedAt"])
        || request.resource.data.joinedAt is timestamp);
    }

    function isInvitee() {
      return isSignedIn()
        && request.auth.token.email != null
        && request.auth.token.email == resource.data.email;
    }

    match /boardInvites/{inviteId} {
      allow create: if isSignedIn()
        && request.resource.data.email is string
        && request.resource.data.boardId is string
        && request.resource.data.invitedById == request.auth.uid
        && request.resource.data.role in ["editor", "viewer"]
        && isBoardOwner(request.resource.data.boardId);
      allow read: if isBoardOwner(resource.data.boardId) || isInvitee();
      allow delete: if isBoardOwner(resource.data.boardId) || isInvitee();
    }

    match /boards/{boardId}/columns/{columnId} {
      allow read: if isBoardMember(boardId) && hasBoardRole(boardId);
      allow create: if isBoardEditor(boardId)
        && columnKeysValid()
        && columnHasRequired()
        && columnTitleValid()
        && columnOrderValid()
        && columnTimestampsValid();
      allow update: if isBoardEditor(boardId)
        && columnKeysValid()
        && columnHasRequired()
        && columnTitleValid()
        && columnOrderValid()
        && columnTimestampsValid()
        && columnCreatedAtUnchanged();
      allow delete: if isBoardOwner(boardId);
    }

    match /boards/{boardId}/cards/{cardId} {
      allow read: if isBoardMember(boardId) && hasBoardRole(boardId);
      allow create: if isBoardEditor(boardId)
        && cardKeysValid()
        && cardHasRequired()
        && cardColumnValid()
        && cardTitleValid()
        && cardOrderValid()
        && cardCreatedByValid()
        && cardDescriptionValid()
        && cardAssigneesValid()
        && cardLabelsValid()
        && cardDueAtValid()
        && cardArchivedValid()
        && cardTimestampsValid();
      allow update: if isBoardEditor(boardId)
        && cardKeysValid()
        && cardHasRequired()
        && cardColumnValid()
        && cardTitleValid()
        && cardOrderValid()
        && cardCreatedByValid()
        && cardDescriptionValid()
        && cardAssigneesValid()
        && cardLabelsValid()
        && cardDueAtValid()
        && cardArchivedValid()
        && cardTimestampsValid()
        && cardCreatedByUnchanged()
        && cardCreatedAtUnchanged();
      allow delete: if isBoardOwner(boardId);
    }

    match /boards/{boardId}/memberProfiles/{memberId} {
      allow read: if isBoardMember(boardId);
      allow create, update: if isSignedIn()
        && request.auth.uid == memberId
        && isBoardMember(boardId)
        && memberProfileKeysValid()
        && memberProfileDataValid();
      allow delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
